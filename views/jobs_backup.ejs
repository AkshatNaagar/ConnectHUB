<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .job-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .job-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .salary-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .company-logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
    </style>
</head>
<body class="bg-light">
    <%- include('partials/navbar') %>
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-briefcase"></i> Job Openings</h2>
                    <span class="badge bg-primary" id="jobCount">Loading...</span>
                </div>
                
                <!-- Filters -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchQuery" placeholder="Job title, keywords...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="jobType">
                                    <option value="">All Types</option>
                                    <option value="full-time">Full Time</option>
                                    <option value="part-time">Part Time</option>
                                    <option value="contract">Contract</option>
                                    <option value="internship">Internship</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="location" placeholder="Location">
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-primary w-100" id="searchBtn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Job Listings -->
                <div id="jobListings">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Loading jobs...</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <% if (user && user.role === 'company') { %>
                <div class="card mb-3 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-plus-circle display-4 text-primary mb-3"></i>
                        <h5>Post a Job</h5>
                        <p class="text-muted small">Reach thousands of talented professionals</p>
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#createJobModal">
                            <i class="bi bi-plus"></i> Create Listing
                        </button>
                    </div>
                </div>
                <% } %>
                
                <!-- Job Stats -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> Quick Stats</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">Full Time</span>
                            <strong id="fullTimeCount">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">Internships</span>
                            <strong id="internshipCount">0</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Companies</span>
                            <strong id="companyCount">0</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Job Modal -->
    <% if (user && user.role === 'company') { %>
    <div class="modal fade" id="createJobModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-briefcase"></i> Post a Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createJobForm">
                        <div class="mb-3">
                            <label class="form-label">Job Title *</label>
                            <input type="text" class="form-control" id="jobTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Job Type *</label>
                            <select class="form-select" id="jobTypeInput" required>
                                <option value="full-time">Full Time</option>
                                <option value="part-time">Part Time</option>
                                <option value="contract">Contract</option>
                                <option value="internship">Internship</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Location *</label>
                            <input type="text" class="form-control" id="jobLocation" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description *</label>
                            <textarea class="form-control" id="jobDescription" rows="4" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Min Salary (₹)</label>
                                <input type="number" class="form-control" id="minSalary">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Max Salary (₹)</label>
                                <input type="number" class="form-control" id="maxSalary">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Requirements (one per line)</label>
                            <textarea class="form-control" id="jobRequirements" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Responsibilities (one per line)</label>
                            <textarea class="form-control" id="jobResponsibilities" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitJobBtn">
                        <i class="bi bi-check"></i> Post Job
                    </button>
                </div>
            </div>
        </div>
    </div>
    <% } %>

    <!-- Edit Job Modal -->
    <% if (user && user.role === 'company') { %>
    <div class="modal fade" id="editJobModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editJobForm">
                        <input type="hidden" id="editJobId">
                        <div class="mb-3">
                            <label class="form-label">Job Title *</label>
                            <input type="text" class="form-control" id="editJobTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Job Type *</label>
                            <select class="form-select" id="editJobType" required>
                                <option value="full-time">Full Time</option>
                                <option value="part-time">Part Time</option>
                                <option value="contract">Contract</option>
                                <option value="internship">Internship</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Location *</label>
                            <input type="text" class="form-control" id="editJobLocation" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description *</label>
                            <textarea class="form-control" id="editJobDescription" rows="4" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Min Salary (₹)</label>
                                <input type="number" class="form-control" id="editMinSalary">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Max Salary (₹)</label>
                                <input type="number" class="form-control" id="editMaxSalary">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Requirements (one per line)</label>
                            <textarea class="form-control" id="editJobRequirements" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Responsibilities (one per line)</label>
                            <textarea class="form-control" id="editJobResponsibilities" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateJobBtn">
                        <i class="bi bi-check"></i> Update Job
                    </button>
                </div>
            </div>
        </div>
    </div>
    <% } %>

    <!-- Job Details Modal -->
    <div class="modal fade" id="jobDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalJobTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalJobContent">
                    <!-- Job details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Apply Job Modal -->
    <div class="modal fade" id="applyJobModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-send"></i> Apply for Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3"><strong id="applyJobTitle"></strong></p>
                    <form id="applyJobForm">
                        <input type="hidden" id="applyJobId">
                        <div class="mb-3">
                            <label class="form-label">Cover Letter</label>
                            <textarea class="form-control" id="coverLetter" rows="5" 
                                placeholder="Tell us why you're a great fit for this position..."></textarea>
                            <small class="text-muted">Optional but recommended</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitApplicationBtn">
                        <i class="bi bi-send"></i> Submit Application
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('Jobs page script loaded');
        
        // Current user data
        const currentUser = {
            id: '<%= user._id %>',
            role: '<%= user.role %>'
        };
        
        let allJobs = [];
        
        async function loadJobs() {
            try {
                const query = document.getElementById('searchQuery').value;
                const type = document.getElementById('jobType').value;
                const location = document.getElementById('location').value;
                
                const params = new URLSearchParams();
                if (query) params.append('query', query);
                if (type) params.append('type', type);
                if (location) params.append('location', location);
                
                const response = await fetch(`/api/jobs?${params}`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('Jobs API response:', data);
                
                // The API returns data.data which contains { jobs, total, page, limit }
                allJobs = data.data?.jobs || [];
                displayJobs(allJobs);
                updateStats(allJobs);
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('jobListings').innerHTML = 
                    '<div class="alert alert-danger">Error loading jobs. Please try again.</div>';
            }
        }
        
        function displayJobs(jobs) {
            const container = document.getElementById('jobListings');
            document.getElementById('jobCount').textContent = `${jobs.length} Jobs`;
            
            if (jobs.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-briefcase display-1 text-muted"></i>
                            <h5 class="mt-3">No jobs found</h5>
                            <p class="text-muted">Try adjusting your search filters</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            try {
                container.innerHTML = jobs.map(job => {
                    try {
                        const companyInitial = job.company ? job.company.charAt(0).toUpperCase() : 'C';
                        const salaryText = job.salary && job.salary.min ? 
                            `₹${(job.salary.min/100000).toFixed(1)}L - ₹${(job.salary.max/100000).toFixed(1)}L` : 
                            'Not disclosed';
                        
                        const title = escapeHtml(job.title || '');
                        const company = escapeHtml(job.company || 'Company');
                        const location = escapeHtml(job.location || '');
                        const description = escapeHtml(job.description ? job.description.substring(0, 150) : '');
                        
                        // Check if this job is posted by the current user (recruiter)
                        // postedBy can be either an ObjectId string or a populated object with _id
                        const jobPosterId = job.postedBy?._id || job.postedBy;
                        const isOwnJob = currentUser.role === 'company' && jobPosterId && jobPosterId.toString() === currentUser.id.toString();
                        
                        console.log('Job:', job.title, 'Posted by:', jobPosterId, 'Current user:', currentUser.id, 'Is own job:', isOwnJob);
                        
                        // Generate action buttons based on user role and job ownership
                        let actionButtons = '';
                        if (isOwnJob) {
                            // Show Edit and Delete for recruiter's own jobs
                            actionButtons = `
                                <button class="btn btn-outline-primary btn-sm view-details-btn" data-job-id="${job._id}">
                                    <i class="bi bi-info-circle"></i> View Details
                                </button>
                                <button class="btn btn-warning btn-sm edit-job-btn" data-job-id="${job._id}">
                                    <i class="bi bi-pencil"></i> Edit Details
                                </button>
                                <button class="btn btn-danger btn-sm delete-job-btn" data-job-id="${job._id}">
                                    <i class="bi bi-trash"></i> Delete Job
                                </button>
                            `;
                        } else {
                            // Show Apply for job seekers or other company's jobs
                            actionButtons = `
                                <button class="btn btn-outline-primary btn-sm view-details-btn" data-job-id="${job._id}">
                                    <i class="bi bi-info-circle"></i> View Details
                                </button>
                                <button class="btn btn-primary btn-sm apply-job-btn" data-job-id="${job._id}">
                                    <i class="bi bi-send"></i> Apply Now
                                </button>
                            `;
                        }
                        
                        return `
                            <div class="card mb-3 job-card shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="company-logo me-3">${companyInitial}</div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-1">${title}</h5>
                                            <p class="text-muted mb-2">
                                                <i class="bi bi-building"></i> ${company}
                                                <span class="mx-2">•</span>
                                                <i class="bi bi-geo-alt"></i> ${location}
                                            </p>
                                            <p class="mb-2">${description}...</p>
                                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                                <span class="badge bg-primary">${job.type}</span>
                                                <span class="badge salary-badge text-white">${salaryText}</span>
                                                <span class="text-muted small ms-auto">
                                                    <i class="bi bi-eye"></i> ${job.views || 0} views
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        ${actionButtons}
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (jobError) {
                        console.error('Error rendering job:', job, jobError);
                        return ''; // Skip this job if there's an error
                    }
                }).join('');
            } catch (error) {
                console.error('Error in displayJobs:', error);
                container.innerHTML = '<div class="alert alert-danger">Error displaying jobs. Please refresh.</div>';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function updateStats(jobs) {
            const fullTime = jobs.filter(j => j.type === 'full-time').length;
            const internship = jobs.filter(j => j.type === 'internship').length;
            const companies = new Set(jobs.map(j => j.company)).size;
            
            document.getElementById('fullTimeCount').textContent = fullTime;
            document.getElementById('internshipCount').textContent = internship;
            document.getElementById('companyCount').textContent = companies;
        }
        
        async function viewJobDetails(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!response.ok) {
                    alert('Error loading job details');
                    return;
                }
                
                const job = data.data.job;
                
                document.getElementById('modalJobTitle').textContent = job.title;
                
                const salaryText = job.salary && job.salary.min ? 
                    `₹${(job.salary.min/100000).toFixed(1)}L - ₹${(job.salary.max/100000).toFixed(1)}L per year` : 
                    'Not disclosed';
                
                document.getElementById('modalJobContent').innerHTML = `
                    <div class="mb-3">
                        <h6><i class="bi bi-building"></i> ${escapeHtml(job.company)}</h6>
                        <p class="text-muted"><i class="bi bi-geo-alt"></i> ${escapeHtml(job.location)}</p>
                        <span class="badge bg-primary">${job.type}</span>
                        <span class="badge salary-badge text-white ms-2">${salaryText}</span>
                    </div>
                    
                    <hr>
                    
                    <h6>Description</h6>
                    <p>${escapeHtml(job.description)}</p>
                    
                    ${job.requirements && job.requirements.length > 0 ? `
                        <h6 class="mt-4">Requirements</h6>
                        <ul>
                            ${job.requirements.map(req => `<li>${escapeHtml(req)}</li>`).join('')}
                        </ul>
                    ` : ''}
                    
                    ${job.responsibilities && job.responsibilities.length > 0 ? `
                        <h6 class="mt-4">Responsibilities</h6>
                        <ul>
                            ${job.responsibilities.map(resp => `<li>${escapeHtml(resp)}</li>`).join('')}
                        </ul>
                    ` : ''}
                    
                    <div class="mt-4">
                        <button class="btn btn-primary btn-lg apply-from-details-btn" data-job-id="${job._id}" data-job-title="${escapeHtml(job.title)}">
                            <i class="bi bi-send"></i> Apply for this position
                        </button>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading job details');
            }
        }
        
        function openApplyModal(jobId, jobTitle) {
            document.getElementById('applyJobId').value = jobId;
            document.getElementById('applyJobTitle').textContent = jobTitle;
            document.getElementById('coverLetter').value = '';
            
            // Close job details modal if open
            const detailsModal = bootstrap.Modal.getInstance(document.getElementById('jobDetailsModal'));
            if (detailsModal) {
                detailsModal.hide();
            }
            
            // Show apply modal
            new bootstrap.Modal(document.getElementById('applyJobModal')).show();
        }
        
        document.getElementById('submitApplicationBtn').addEventListener('click', async () => {
            const jobId = document.getElementById('applyJobId').value;
            const coverLetter = document.getElementById('coverLetter').value;
            
            try {
                const response = await fetch(`/api/jobs/${jobId}/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ coverLetter: coverLetter || '' })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('✅ Application submitted successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('applyJobModal')).hide();
                } else {
                    alert('❌ ' + (data.message || 'Error submitting application'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Error submitting application');
            }
        });
        
        async function applyForJob(jobId) {
            // Get job title first
            const job = allJobs.find(j => j._id === jobId);
            const jobTitle = job ? job.title : 'this position';
            openApplyModal(jobId, jobTitle);
        }
        
        <% if (user && user.role === 'company') { %>
        document.getElementById('submitJobBtn').addEventListener('click', async () => {
            const jobData = {
                title: document.getElementById('jobTitle').value,
                type: document.getElementById('jobTypeInput').value,
                location: document.getElementById('jobLocation').value,
                description: document.getElementById('jobDescription').value,
                company: '<%= user.companyInfo ? user.companyInfo.companyName : user.name %>',
                salary: {
                    min: parseInt(document.getElementById('minSalary').value) || 0,
                    max: parseInt(document.getElementById('maxSalary').value) || 0,
                    currency: 'INR'
                },
                requirements: document.getElementById('jobRequirements').value.split('\n').filter(r => r.trim()),
                responsibilities: document.getElementById('jobResponsibilities').value.split('\n').filter(r => r.trim())
            };
            
            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(jobData)
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('Job posted successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createJobModal')).hide();
                    document.getElementById('createJobForm').reset();
                    loadJobs();
                } else {
                    alert(data.message || 'Error creating job');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating job');
            }
        });
        
        // Update job handler
        document.getElementById('updateJobBtn').addEventListener('click', async () => {
            const jobId = document.getElementById('editJobId').value;
            const jobData = {
                title: document.getElementById('editJobTitle').value,
                type: document.getElementById('editJobType').value,
                location: document.getElementById('editJobLocation').value,
                description: document.getElementById('editJobDescription').value,
                salary: {
                    min: parseInt(document.getElementById('editMinSalary').value) || 0,
                    max: parseInt(document.getElementById('editMaxSalary').value) || 0,
                    currency: 'INR'
                },
                requirements: document.getElementById('editJobRequirements').value.split('\n').filter(r => r.trim()),
                responsibilities: document.getElementById('editJobResponsibilities').value.split('\n').filter(r => r.trim())
            };
            
            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(jobData)
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('✅ Job updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editJobModal')).hide();
                    loadJobs();
                } else {
                    alert('❌ ' + (data.message || 'Error updating job'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Error updating job');
            }
        });
        <% } %>
        
        document.getElementById('searchBtn').addEventListener('click', loadJobs);
        document.getElementById('searchQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadJobs();
        });
        
        // Event delegation for dynamically created buttons
        document.getElementById('jobListings').addEventListener('click', (e) => {
            if (e.target.classList.contains('view-details-btn') || e.target.closest('.view-details-btn')) {
                const btn = e.target.classList.contains('view-details-btn') ? e.target : e.target.closest('.view-details-btn');
                const jobId = btn.getAttribute('data-job-id');
                viewJobDetails(jobId);
            }
            
            if (e.target.classList.contains('apply-job-btn') || e.target.closest('.apply-job-btn')) {
                const btn = e.target.classList.contains('apply-job-btn') ? e.target : e.target.closest('.apply-job-btn');
                const jobId = btn.getAttribute('data-job-id');
                applyForJob(jobId);
            }
            
            if (e.target.classList.contains('edit-job-btn') || e.target.closest('.edit-job-btn')) {
                const btn = e.target.classList.contains('edit-job-btn') ? e.target : e.target.closest('.edit-job-btn');
                const jobId = btn.getAttribute('data-job-id');
                editJob(jobId);
            }
            
            if (e.target.classList.contains('delete-job-btn') || e.target.closest('.delete-job-btn')) {
                const btn = e.target.classList.contains('delete-job-btn') ? e.target : e.target.closest('.delete-job-btn');
                const jobId = btn.getAttribute('data-job-id');
                deleteJob(jobId);
            }
        });
        
        // Edit job function
        async function editJob(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!response.ok) {
                    alert('Error loading job details');
                    return;
                }
                
                const job = data.data.job;
                
                // Populate edit form
                document.getElementById('editJobId').value = job._id;
                document.getElementById('editJobTitle').value = job.title;
                document.getElementById('editJobType').value = job.type;
                document.getElementById('editJobLocation').value = job.location;
                document.getElementById('editJobDescription').value = job.description;
                document.getElementById('editMinSalary').value = job.salary?.min || '';
                document.getElementById('editMaxSalary').value = job.salary?.max || '';
                document.getElementById('editJobRequirements').value = job.requirements?.join('\n') || '';
                document.getElementById('editJobResponsibilities').value = job.responsibilities?.join('\n') || '';
                
                // Show edit modal
                new bootstrap.Modal(document.getElementById('editJobModal')).show();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading job details');
            }
        }
        
        // Delete job function
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job posting? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('✅ Job deleted successfully!');
                    loadJobs(); // Reload jobs list
                } else {
                    alert('❌ ' + (data.message || 'Error deleting job'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Error deleting job');
            }
        }
        });
        
        // Event delegation for dynamically created buttons
        document.addEventListener('click', function(e) {
            // View Details button
            if (e.target.closest('.view-details-btn')) {
                const btn = e.target.closest('.view-details-btn');
                const jobId = btn.getAttribute('data-job-id');
                viewJobDetails(jobId);
            }
            
            // Apply Now button (from job card)
            if (e.target.closest('.apply-job-btn')) {
                const btn = e.target.closest('.apply-job-btn');
                const jobId = btn.getAttribute('data-job-id');
                applyForJob(jobId);
            }
            
            // Apply button (from details modal)
            if (e.target.closest('.apply-from-details-btn')) {
                const btn = e.target.closest('.apply-from-details-btn');
                const jobId = btn.getAttribute('data-job-id');
                const jobTitle = btn.getAttribute('data-job-title');
                openApplyModal(jobId, jobTitle);
            }
        });
        
        loadJobs();
    </script>
</body>
</html>
