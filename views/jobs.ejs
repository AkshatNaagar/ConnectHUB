<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobs - ConnectHUB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0a66c2;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }
        
        body {
            background-color: #f3f2ef;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), #0077b5);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .job-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .company-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), #0077b5);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .salary-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            font-weight: 600;
        }
        
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stats-card .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .application-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.75rem;
        }
        
        .tab-content {
            background: transparent;
        }
        
        .nav-tabs {
            background: white;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 6px;
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
        }
        
        .filter-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #0077b5);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .application-card {
            border-left: 4px solid var(--primary-color);
        }
        
        .application-card.pending {
            border-left-color: var(--warning-color);
        }
        
        .application-card.accepted {
            border-left-color: var(--success-color);
        }
        
        .application-card.rejected {
            border-left-color: var(--danger-color);
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>
    
    <div class="page-header">
        <div class="container">
            <h1><i class="bi bi-briefcase-fill"></i> Job Portal</h1>
            <p class="lead mb-0">Find your dream job or hire the best talent</p>
        </div>
    </div>
    
    <div class="container">
        <!-- Role-based tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse" type="button" role="tab">
                    <i class="bi bi-search"></i> Browse Jobs
                </button>
            </li>
            <% if (user && user.role === 'company') { %>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="my-jobs-tab" data-bs-toggle="tab" data-bs-target="#my-jobs" type="button" role="tab">
                    <i class="bi bi-briefcase"></i> My Job Postings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="applications-tab" data-bs-toggle="tab" data-bs-target="#applications" type="button" role="tab">
                    <i class="bi bi-file-earmark-text"></i> Applications
                </button>
            </li>
            <% } %>
        </ul>
        
        <div class="tab-content mt-3">
            <!-- Browse Jobs Tab -->
            <div class="tab-pane fade show active" id="browse" role="tabpanel">
                <div class="filter-section">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" id="searchQuery" class="form-control" placeholder="Search jobs...">
                        </div>
                        <div class="col-md-3">
                            <select id="filterType" class="form-select">
                                <option value="">All Types</option>
                                <option value="full-time">Full Time</option>
                                <option value="part-time">Part Time</option>
                                <option value="contract">Contract</option>
                                <option value="internship">Internship</option>
                                <option value="remote">Remote</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="filterLocation" class="form-control" placeholder="Location">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadJobs()">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="jobListings">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading jobs...</p>
                    </div>
                </div>
            </div>
            
            <!-- My Jobs Tab (Recruiter Only) -->
            <% if (user && user.role === 'company') { %>
            <div class="tab-pane fade" id="my-jobs" role="tabpanel">
                <div class="mb-3">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createJobModal">
                        <i class="bi bi-plus-lg"></i> Post New Job
                    </button>
                </div>
                <div id="myJobListings">
                    <div class="text-center py-5">
                        <p class="text-muted">Click "Post New Job" to create your first job posting</p>
                    </div>
                </div>
            </div>
            
            <!-- Applications Tab (Recruiter Only) -->
            <div class="tab-pane fade" id="applications" role="tabpanel">
                <div id="applicationsList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>
        </div>
    </div>
    
    <!-- Create/Edit Job Modal -->
    <div class="modal fade" id="createJobModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Post New Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="jobForm">
                        <input type="hidden" id="jobId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Job Title *</label>
                                <input type="text" class="form-control" id="jobTitle" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company Name *</label>
                                <input type="text" class="form-control" id="jobCompany" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Location *</label>
                                <input type="text" class="form-control" id="jobLocation" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Job Type *</label>
                                <select class="form-select" id="jobType" required>
                                    <option value="full-time">Full Time</option>
                                    <option value="part-time">Part Time</option>
                                    <option value="contract">Contract</option>
                                    <option value="internship">Internship</option>
                                    <option value="remote">Remote</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Min Salary (‚Çπ)</label>
                                <input type="number" class="form-control" id="jobSalaryMin" placeholder="300000">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Max Salary (‚Çπ)</label>
                                <input type="number" class="form-control" id="jobSalaryMax" placeholder="600000">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description * <small class="text-muted">(minimum 50 characters)</small></label>
                                <textarea class="form-control" id="jobDescription" rows="4" required minlength="50" placeholder="Provide a detailed job description..."></textarea>
                                <small class="text-muted"><span id="descCharCount">0</span>/50 characters</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Requirements (one per line)</label>
                                <textarea class="form-control" id="jobRequirements" rows="3" placeholder="Bachelor's degree in CS&#10;2+ years experience&#10;Proficient in JavaScript"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Responsibilities (one per line)</label>
                                <textarea class="form-control" id="jobResponsibilities" rows="3" placeholder="Develop web applications&#10;Code review&#10;Team collaboration"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="postJobBtn">
                        <i class="bi bi-check-lg"></i> Post Job
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Job Details Modal -->
    <div class="modal fade" id="jobDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsJobTitle">Job Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="jobDetailsContent">
                    <!-- Details loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Apply Modal -->
    <div class="modal fade" id="applyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-send"></i> Apply for Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="applyJobId">
                    <div class="mb-3">
                        <label class="form-label">Cover Letter (Optional)</label>
                        <textarea class="form-control" id="coverLetter" rows="5" placeholder="Tell us why you're a great fit for this position..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitApplicationBtn">
                        <i class="bi bi-send"></i> Submit Application
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const currentUser = {
            id: '<%= user ? user._id : "" %>',
            role: '<%= user ? user.role : "guest" %>'
        };
        
        let allJobs = [];
        let myJobs = [];
        
        // Load all jobs
        async function loadJobs() {
            try {
                const query = document.getElementById('searchQuery').value;
                const type = document.getElementById('filterType').value;
                const location = document.getElementById('filterLocation').value;
                
                const params = new URLSearchParams();
                if (query) params.append('query', query);
                if (type) params.append('type', type);
                if (location) params.append('location', location);
                
                const response = await fetch(`/api/jobs?${params}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    allJobs = data.data.jobs;
                    displayJobs(allJobs);
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('jobListings').innerHTML = 
                    '<div class="alert alert-danger">Error loading jobs. Please try again.</div>';
            }
        }
        
        // Display jobs
        function displayJobs(jobs) {
            const container = document.getElementById('jobListings');
            
            if (jobs.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-briefcase display-1 text-muted"></i>
                            <h5 class="mt-3">No jobs found</h5>
                            <p class="text-muted">Try adjusting your search filters</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = jobs.map(job => {
                const companyInitial = job.company ? job.company.charAt(0).toUpperCase() : 'C';
                const salaryText = job.salary && job.salary.min ? 
                    `‚Çπ${(job.salary.min/100000).toFixed(1)}L - ‚Çπ${(job.salary.max/100000).toFixed(1)}L` : 
                    'Not disclosed';
                
                const hasApplied = job.applications && job.applications.some(app => 
                    app.applicant && app.applicant.toString() === currentUser.id
                );
                
                return `
                    <div class="card job-card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="company-logo me-3">${companyInitial}</div>
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">${escapeHtml(job.title)}</h5>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-building"></i> ${escapeHtml(job.company)}
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="bi bi-geo-alt"></i> ${escapeHtml(job.location)}
                                    </p>
                                    <p class="mb-2">${escapeHtml(job.description.substring(0, 150))}...</p>
                                    <div class="d-flex flex-wrap gap-2 align-items-center">
                                        <span class="badge bg-primary">${job.type}</span>
                                        <span class="badge salary-badge">${salaryText}</span>
                                        <span class="text-muted small ms-auto">
                                            <i class="bi bi-eye"></i> ${job.views || 0} views
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm view-details-btn" data-job-id="${job._id}">
                                    <i class="bi bi-info-circle"></i> View Details
                                </button>
                                ${currentUser.role === 'company' ? 
                                    '' : 
                                    hasApplied ? 
                                        '<span class="badge bg-success ms-2"><i class="bi bi-check-circle"></i> Applied</span>' : 
                                        `<button class="btn btn-primary btn-sm apply-btn" data-job-id="${job._id}">
                                            <i class="bi bi-send"></i> Apply Now
                                        </button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Load my jobs (recruiter)
        async function loadMyJobs() {
            try {
                const response = await fetch('/api/jobs', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    myJobs = data.data.jobs.filter(job => 
                        job.postedBy && (job.postedBy._id || job.postedBy) === currentUser.id
                    );
                    displayMyJobs(myJobs);
                }
            } catch (error) {
                console.error('Error loading my jobs:', error);
            }
        }
        
        // Display my jobs
        function displayMyJobs(jobs) {
            const container = document.getElementById('myJobListings');
            
            if (jobs.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> You haven't posted any jobs yet. Click "Post New Job" to get started.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = jobs.map(job => {
                const applicationCount = job.applications ? job.applications.length : 0;
                const salaryText = job.salary && job.salary.min ? 
                    `‚Çπ${(job.salary.min/100000).toFixed(1)}L - ‚Çπ${(job.salary.max/100000).toFixed(1)}L` : 
                    'Not disclosed';
                
                return `
                    <div class="card job-card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">${escapeHtml(job.title)}</h5>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-building"></i> ${escapeHtml(job.company)}
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="bi bi-geo-alt"></i> ${escapeHtml(job.location)}
                                    </p>
                                    <div class="d-flex gap-2 align-items-center mb-2">
                                        <span class="badge bg-primary">${job.type}</span>
                                        <span class="badge salary-badge">${salaryText}</span>
                                        <span class="badge bg-info">
                                            <i class="bi bi-file-earmark-text"></i> ${applicationCount} applications
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-warning btn-sm edit-job-btn" data-job-id="${job._id}">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm delete-job-btn" data-job-id="${job._id}">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Load applications (recruiter)
        async function loadApplications() {
            try {
                const response = await fetch('/api/jobs/applications/my', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    displayApplications(data.data.applications);
                }
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }
        
        // Display applications
        function displayApplications(applications) {
            const container = document.getElementById('applicationsList');
            
            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No applications received yet.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = applications.map(app => {
                const statusColor = {
                    'pending': 'warning',
                    'accepted': 'success',
                    'rejected': 'danger'
                };
                
                return `
                    <div class="card application-card ${app.status} shadow-sm mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(app.applicant.name)}</h6>
                                    <p class="text-muted mb-2">
                                        <small><i class="bi bi-envelope"></i> ${escapeHtml(app.applicant.email)}</small>
                                    </p>
                                    <p class="mb-1"><strong>Job:</strong> ${escapeHtml(app.jobTitle)}</p>
                                    <p class="mb-2"><small><i class="bi bi-calendar"></i> Applied: ${new Date(app.appliedAt).toLocaleDateString()}</small></p>
                                    ${app.coverLetter ? `<p class="mb-2"><small>${escapeHtml(app.coverLetter)}</small></p>` : ''}
                                    <span class="badge bg-${statusColor[app.status]}">${app.status.toUpperCase()}</span>
                                </div>
                            </div>
                            ${app.status === 'pending' ? `
                                <div class="mt-3">
                                    <button class="btn btn-success btn-sm accept-app-btn" data-job-id="${app.jobId}" data-app-id="${app._id}">
                                        <i class="bi bi-check-circle"></i> Accept
                                    </button>
                                    <button class="btn btn-danger btn-sm reject-app-btn" data-job-id="${app.jobId}" data-app-id="${app._id}">
                                        <i class="bi bi-x-circle"></i> Reject
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // View job details
        async function viewJobDetails(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`, { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    const job = data.data.job;
                    document.getElementById('detailsJobTitle').textContent = job.title;
                    
                    const salaryText = job.salary && job.salary.min ? 
                        `‚Çπ${(job.salary.min/100000).toFixed(1)}L - ‚Çπ${(job.salary.max/100000).toFixed(1)}L per year` : 
                        'Not disclosed';
                    
                    document.getElementById('jobDetailsContent').innerHTML = `
                        <div class="mb-3">
                            <h6><i class="bi bi-building"></i> ${escapeHtml(job.company)}</h6>
                            <p class="text-muted"><i class="bi bi-geo-alt"></i> ${escapeHtml(job.location)}</p>
                            <span class="badge bg-primary">${job.type}</span>
                            <span class="badge salary-badge ms-2">${salaryText}</span>
                        </div>
                        
                        <hr>
                        
                        <h6>Description</h6>
                        <p>${escapeHtml(job.description)}</p>
                        
                        ${job.requirements && job.requirements.length > 0 ? `
                            <h6 class="mt-4">Requirements</h6>
                            <ul>
                                ${job.requirements.map(req => `<li>${escapeHtml(req)}</li>`).join('')}
                            </ul>
                        ` : ''}
                        
                        ${job.responsibilities && job.responsibilities.length > 0 ? `
                            <h6 class="mt-4">Responsibilities</h6>
                            <ul>
                                ${job.responsibilities.map(resp => `<li>${escapeHtml(resp)}</li>`).join('')}
                            </ul>
                        ` : ''}
                    `;
                    
                    new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
                }
            } catch (error) {
                console.error('Error loading job details:', error);
                alert('Error loading job details');
            }
        }
        
        // Open apply modal
        function openApplyModal(jobId) {
            document.getElementById('applyJobId').value = jobId;
            document.getElementById('coverLetter').value = '';
            new bootstrap.Modal(document.getElementById('applyModal')).show();
        }
        
        // Submit application
        async function submitApplication() {
            console.log('=== submitApplication called ===');
            
            const jobId = document.getElementById('applyJobId').value;
            const coverLetter = document.getElementById('coverLetter').value;
            
            console.log('Applying to job:', jobId);
            
            if (!jobId) {
                alert('‚ùå Job ID is missing. Please try again.');
                return;
            }
            
            try {
                const response = await fetch(`/api/jobs/${jobId}/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ coverLetter })
                });
                
                console.log('Application response status:', response.status);
                
                const data = await response.json();
                console.log('Application response data:', data);
                
                if (data.success) {
                    alert('‚úÖ Application submitted successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('applyModal'));
                    if (modal) modal.hide();
                    document.getElementById('coverLetter').value = '';
                    loadJobs();
                } else {
                    alert('‚ùå ' + (data.message || 'Failed to submit application'));
                }
            } catch (error) {
                console.error('‚ùå Error submitting application:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Save job (create or update)
        async function saveJob() {
            console.log('üöÄ saveJob function called');
            
            // Get form values
            const jobId = document.getElementById('jobId')?.value || '';
            const title = document.getElementById('jobTitle')?.value || '';
            const company = document.getElementById('jobCompany')?.value || '';
            const location = document.getElementById('jobLocation')?.value || '';
            const type = document.getElementById('jobType')?.value || 'full-time';
            const description = document.getElementById('jobDescription')?.value || '';
            const salaryMin = document.getElementById('jobSalaryMin')?.value || '';
            const salaryMax = document.getElementById('jobSalaryMax')?.value || '';
            const requirementsText = document.getElementById('jobRequirements')?.value || '';
            const responsibilitiesText = document.getElementById('jobResponsibilities')?.value || '';
            
            console.log('üìù Form Data:', {
                jobId,
                title: title.substring(0, 20),
                company: company.substring(0, 20),
                location: location.substring(0, 20),
                type,
                descriptionLength: description.length,
                salaryMin,
                salaryMax
            });
            
            // Validate required fields
            if (!title || title.trim().length < 3) {
                alert('‚ùå Job title must be at least 3 characters long.');
                document.getElementById('jobTitle')?.focus();
                return;
            }
            
            if (!company || company.trim().length < 2) {
                alert('‚ùå Company name is required (at least 2 characters).');
                document.getElementById('jobCompany')?.focus();
                return;
            }
            
            if (!location || location.trim().length < 2) {
                alert('‚ùå Location is required (at least 2 characters).');
                document.getElementById('jobLocation')?.focus();
                return;
            }
            
            if (!description || description.trim().length < 50) {
                alert('‚ùå Description must be at least 50 characters.\n\nYou have: ' + description.length + ' characters\nYou need: 50 characters\n\nPlease write a more detailed job description.');
                document.getElementById('jobDescription')?.focus();
                return;
            }
            
            // Parse arrays
            const requirements = requirementsText.split('\n').map(r => r.trim()).filter(r => r.length > 0);
            const responsibilities = responsibilitiesText.split('\n').map(r => r.trim()).filter(r => r.length > 0);
            
            // Build job data object
            const jobData = {
                title: title.trim(),
                company: company.trim(),
                location: location.trim(),
                type: type,
                description: description.trim(),
                salary: {
                    min: salaryMin ? parseInt(salaryMin) : 0,
                    max: salaryMax ? parseInt(salaryMax) : 0
                },
                requirements: requirements,
                responsibilities: responsibilities
            };
            
            console.log('üì§ Sending job data:', jobData);
            
            try {
                // Determine endpoint
                const url = jobId ? `/api/jobs/${jobId}` : '/api/jobs';
                const method = jobId ? 'PUT' : 'POST';
                
                console.log(`üì° ${method} ${url}`);
                
                // Send request
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(jobData)
                });
                
                console.log('üì® Response status:', response.status);
                
                // Parse response
                const result = await response.json();
                console.log('üì¶ Response data:', result);
                
                if (response.ok && result.success) {
                    // Success
                    console.log('‚úÖ Job saved successfully');
                    
                    // Close modal
                    const modalElement = document.getElementById('createJobModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Reset form
                    document.getElementById('jobForm')?.reset();
                    document.getElementById('jobId').value = '';
                    const descCount = document.getElementById('descCharCount');
                    if (descCount) descCount.textContent = '0';
                    
                    // Reload jobs and switch to appropriate tab
                    if (currentUser.role === 'company') {
                        // Switch to My Job Postings tab first
                        const myJobsTab = document.getElementById('my-jobs-tab');
                        if (myJobsTab) {
                            const tabInstance = new bootstrap.Tab(myJobsTab);
                            tabInstance.show();
                        }
                        
                        // Load jobs (will show in My Jobs tab)
                        await loadMyJobs();
                    } else {
                        loadJobs();
                    }
                    
                    // Show success message
                    alert(jobId ? '‚úÖ Job updated successfully!' : '‚úÖ Job posted successfully!');
                } else {
                    // Error from server
                    console.error('‚ùå Server error:', result);
                    
                    // Handle validation errors
                    if (result.errors && Array.isArray(result.errors)) {
                        const errorMessages = result.errors.map(err => `${err.field}: ${err.message}`).join('\n');
                        alert('‚ùå Validation Error:\n\n' + errorMessages);
                    } else {
                        alert('‚ùå Error: ' + (result.message || 'Failed to save job'));
                    }
                }
            } catch (error) {
                // Network or other error
                console.error('‚ùå Error:', error);
                alert('‚ùå Network error: ' + error.message + '\n\nPlease check your internet connection and try again.');
            }
        }
        
        // Edit job
        async function editJob(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`, { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    const job = data.data.job;
                    document.getElementById('jobId').value = job._id;
                    document.getElementById('jobTitle').value = job.title;
                    document.getElementById('jobCompany').value = job.company;
                    document.getElementById('jobLocation').value = job.location;
                    document.getElementById('jobType').value = job.type;
                    document.getElementById('jobDescription').value = job.description;
                    document.getElementById('jobSalaryMin').value = job.salary?.min || '';
                    document.getElementById('jobSalaryMax').value = job.salary?.max || '';
                    document.getElementById('jobRequirements').value = job.requirements ? job.requirements.join('\n') : '';
                    document.getElementById('jobResponsibilities').value = job.responsibilities ? job.responsibilities.join('\n') : '';
                    
                    document.querySelector('#createJobModal .modal-title').innerHTML = '<i class="bi bi-pencil"></i> Edit Job';
                    new bootstrap.Modal(document.getElementById('createJobModal')).show();
                }
            } catch (error) {
                console.error('Error loading job:', error);
                alert('Error loading job');
            }
        }
        
        // Delete job
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job?')) return;
            
            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Job deleted successfully!');
                    loadMyJobs();
                } else {
                    alert(data.message || 'Failed to delete job');
                }
            } catch (error) {
                console.error('Error deleting job:', error);
                alert('Error deleting job');
            }
        }
        
        // Accept application
        async function acceptApplication(jobId, applicationId) {
            if (!confirm('Accept this application?')) return;
            
            try {
                const response = await fetch(`/api/jobs/${jobId}/applications/${applicationId}/accept`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Application accepted! Notification sent to applicant.');
                    loadApplications();
                } else {
                    alert(data.message || 'Failed to accept application');
                }
            } catch (error) {
                console.error('Error accepting application:', error);
                alert('Error accepting application');
            }
        }
        
        // Reject application
        async function rejectApplication(jobId, applicationId) {
            if (!confirm('Reject this application?')) return;
            
            try {
                const response = await fetch(`/api/jobs/${jobId}/applications/${applicationId}/reject`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Application rejected. Notification sent to applicant.');
                    loadApplications();
                } else {
                    alert(data.message || 'Failed to reject application');
                }
            } catch (error) {
                console.error('Error rejecting application:', error);
                alert('Error rejecting application');
            }
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Tab event listeners
        document.getElementById('my-jobs-tab')?.addEventListener('shown.bs.tab', () => {
            loadMyJobs();
        });
        
        document.getElementById('applications-tab')?.addEventListener('shown.bs.tab', () => {
            loadApplications();
        });
        
        // Reset modal on close
        document.getElementById('createJobModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('jobForm').reset();
            document.getElementById('jobId').value = '';
            document.querySelector('#createJobModal .modal-title').innerHTML = '<i class="bi bi-plus-circle"></i> Post New Job';
            document.getElementById('descCharCount').textContent = '0';
        });
        
        // Character counter for description
        document.getElementById('jobDescription').addEventListener('input', (e) => {
            const length = e.target.value.length;
            document.getElementById('descCharCount').textContent = length;
            if (length >= 50) {
                document.getElementById('descCharCount').classList.remove('text-danger');
                document.getElementById('descCharCount').classList.add('text-success');
            } else {
                document.getElementById('descCharCount').classList.remove('text-success');
                document.getElementById('descCharCount').classList.add('text-danger');
            }
        });
        
        // Event delegation for dynamically created buttons
        document.getElementById('jobListings').addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.view-details-btn');
            const applyBtn = e.target.closest('.apply-btn');
            
            if (viewBtn) {
                const jobId = viewBtn.getAttribute('data-job-id');
                viewJobDetails(jobId);
            } else if (applyBtn) {
                const jobId = applyBtn.getAttribute('data-job-id');
                openApplyModal(jobId);
            }
        });
        
        // Event delegation for Accept and Reject buttons in Applications tab
        document.addEventListener('click', (e) => {
            const acceptBtn = e.target.closest('.accept-app-btn');
            const rejectBtn = e.target.closest('.reject-app-btn');
            
            if (acceptBtn) {
                const jobId = acceptBtn.getAttribute('data-job-id');
                const appId = acceptBtn.getAttribute('data-app-id');
                acceptApplication(jobId, appId);
            } else if (rejectBtn) {
                const jobId = rejectBtn.getAttribute('data-job-id');
                const appId = rejectBtn.getAttribute('data-app-id');
                rejectApplication(jobId, appId);
            }
        });
        
        // Event delegation for Edit and Delete buttons in My Job Postings tab
        document.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-job-btn');
            const deleteBtn = e.target.closest('.delete-job-btn');
            
            if (editBtn) {
                const jobId = editBtn.getAttribute('data-job-id');
                editJob(jobId);
            } else if (deleteBtn) {
                const jobId = deleteBtn.getAttribute('data-job-id');
                deleteJob(jobId);
            }
        });
        
        // Post Job button event listener
        document.getElementById('postJobBtn').addEventListener('click', (e) => {
            e.preventDefault();
            saveJob();
        });
        
        // Prevent form submission
        document.getElementById('jobForm').addEventListener('submit', (e) => {
            e.preventDefault();
            saveJob();
        });
        
        // Submit Application button event listener
        document.getElementById('submitApplicationBtn').addEventListener('click', (e) => {
            e.preventDefault();
            submitApplication();
        });
        
        // Initial load
        loadJobs();
    </script>
</body>
</html>
